

$components: ();
$relationships: ();
$static-component: null;

@function property-mapping($property, $rule) {
    // TODO: parse rule first

    @if function-exists(map-#{$property}) {
        @return call(map-#{$property}, $rule);
    } @else {
        @return ($property: $rule);
    }
}

@mixin rules(
    $definition,
    $selector: &
) {  
    @at-root #{$selector} {    
        @each $property, $rule in $definition {
            $property-rule-map: property-mapping($property, $rule);
            @each $mapped-property, $mapped-rule in $property-rule-map {
                #{$mapped-property}: $mapped-rule;
            }
        }

        @content;
    }
}

@mixin define-component(
    $component,
    $definition,
    $variant: 'default',
    $placeholder: "%#{$component}#{if($variant == default, '', '-#{$variant}')}"
) {
    $static-component: $component !global;

    $components: set($components, $component $variant, $definition) !global;

    @include rules($definition, $placeholder) {
        @content;
    }

    // Relationship placeholder
    @at-root %r-#{$component}-#{$variant} {
        component: $component $variant;
    }
}

@mixin define-variant(
    $variant,
    $definition,
    $component: $static-component,
    $placeholder: "%#{$component}#{if($variant == default, '', '-#{$variant}')}"
) {
    @include define-component(
        $component,
        $definition,
        $variant,
        $placeholder
    );
}

@mixin define-relationship(
    $target,
    $subject: $static-component,
    $relationship: 'descendant'
) {

    $target-placeholder: relationship($target...);
    $subject-placeholder: relationship($subject...);
    $relationship-map: (
        'descendant': '#{$subject-placeholder} #{$target-placeholder}',
        'child': '#{$subject-placeholder} > #{$target-placeholder}',
        'adjacent': '#{$subject-placeholder} + #{$target-placeholder}',
        'sibling': '#{$subject-placeholder} ~ #{$target-placeholder}',
        'cousin': '#{$subject-placeholder} ~ * #{$target-placeholder}',
    );

    @at-root #{map-get($relationship-map, $relationship)} {
        @content;
    }
}

@function component(
    $name,
    $variant: default
) {
    $variant: if($variant == default, '', '-#{$variant}');

    @return '%#{$name}#{$variant}';
}

@function relationship(
    $component,
    $variant: default
) {
    @return '%r-#{$component}-#{$variant}';
}

@mixin component(
    $component,
    $variant: default
) {
    $static-component: $component !global;

    $component-map: get($components, $component);
    $definition: get($component-map, $variant);

    @include rules($definition, &) {
        @content;
    }

    @extend #{relationship($component, $variant)} !optional;
}

